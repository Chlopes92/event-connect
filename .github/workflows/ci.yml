# Nom du pipeline CI
name: CI Pipeline

# Déclenchement du pipeline
on:
  # À chaque push sur develop ou main
  push:
    branches: [ develop, main ]
  # À chaque pull request vers develop ou main
  pull_request:
    branches: [ develop, main ]

# Variables globales
env:
  JAVA_VERSION: '21' # Version de Java utilisée
  NODE_VERSION: '18' # Version de Node.js utilisée

# un gros bloc de travail indépendants
jobs: 
  # =========================
  # BACKEND
  # =========================

  # Vérifier que le backend compile sans erreur
  build-backend:
    name: Backend - Build
    runs-on: ubuntu-latest # OS utilisé par GitHub Actions

    steps:
      - uses: actions/checkout@v4 # Récupère le code du repo

      - name: Set up JDK
        uses: actions/setup-java@v4 # Installe Java
        with:
          java-version: ${{ env.JAVA_VERSION }} 
          distribution: temurin # Temurin = OpenJDK
          cache: maven # Active le cache Maven

      - name: Compile backend
        working-directory: event-connect-backend
        run: mvn clean compile # Compile le backend

  # Job de tests du backend
  test-backend:
    name: Backend - Tests
    runs-on: ubuntu-latest
    needs: build-backend # Ce job attend que le build soit OK.

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven

      - name: Run tests + coverage
        working-directory: event-connect-backend
        run: mvn test jacoco:report # Lance les tests + couverture

  # Analyse qualité backend avec SonarCloud
  sonar-backend:
    name: Backend - SonarCloud
    runs-on: ubuntu-latest
    needs: test-backend

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Sonar a besoin de l’historique Git complet

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven

      - name: Build & test (required for sonar)
        working-directory: event-connect-backend
        run: mvn test jacoco:report # Requis pour Sonar

      - name: SonarCloud Scan
        working-directory: event-connect-backend
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn sonar:sonar # Analyse SonarCloud


  # =========================
  # FRONTEND
  # =========================

  # Job de tests du frontend
  build-frontend:
    name: Frontend - Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: event-connect-frontend/package-lock.json

      - name: Install dependencies
        working-directory: event-connect-frontend
        run: npm ci

      - name: Build frontend
        working-directory: event-connect-frontend
        run: npm run build -- --configuration=production


  test-frontend:
    name: Frontend - Tests
    runs-on: ubuntu-latest
    needs: build-frontend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: event-connect-frontend/package-lock.json

      - name: Install dependencies
        working-directory: event-connect-frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: event-connect-frontend
        run: npm run test -- --watch=false --browsers=ChromeHeadless --code-coverage

  # Analyse qualité frontend avec SonarCloud
  sonar-frontend:
    name: Frontend - SonarCloud
    runs-on: ubuntu-latest
    needs: test-frontend

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: event-connect-frontend/package-lock.json

      - name: Install dependencies
        working-directory: event-connect-frontend
        run: npm ci

      - name: Run tests with coverage (required for SonarCloud)
        working-directory: event-connect-frontend
        run: npm run test -- --watch=false --browsers=ChromeHeadless --code-coverage

      - name: Install SonarScanner
        run: npm install -g sonarqube-scanner  

      - name: SonarCloud Scan
        working-directory: event-connect-frontend
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        run: |
          sonar-scanner \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}